class e{constructor(e,t,r,s=null,i=null){this.config=e,this.transport=t,this.breadcrumbs=r,this.errorDetector=s,this.sessionManager=i,this.userContext=null,this.tags={},this.extra={},this.pendingBeaconErrors=[],this.cachedSessionHash=null}install(){try{this.initSessionHash().catch(()=>{}),this.processResurrectedErrors(),this.processBufferedErrors(),window.addEventListener("error",e=>{try{this.captureException(e.error||new Error(e.message),{extra:{filename:e.filename,lineno:e.lineno,colno:e.colno}})}catch(e){console.error("ApplicationLogger: Failed to capture error",e)}}),window.addEventListener("unhandledrejection",e=>{try{this.captureException(e.reason,{extra:{type:"unhandledrejection"}})}catch(e){console.error("ApplicationLogger: Failed to capture rejection",e)}}),window.addEventListener("beforeunload",()=>{this.flushBeaconErrors()}),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&this.flushBeaconErrors()}),this.breadcrumbs.install()}catch(e){console.error("ApplicationLogger: Failed to install",e)}}processResurrectedErrors(){try{const e="_appLogger_nuclear",t="_appLogger_resurrection_attempts",r=5,s=864e5,i=parseInt(localStorage.getItem(t)||"0",10);if(i>=r)return this.config.debug&&console.warn("ApplicationLogger: Max resurrection attempts reached, clearing nuclear errors"),localStorage.removeItem(e),void localStorage.removeItem(t);const o=localStorage.getItem(e);if(!o)return;let n;try{n=JSON.parse(o)}catch(t){return this.config.debug&&console.error("ApplicationLogger: Failed to parse nuclear errors, clearing",t),void localStorage.removeItem(e)}if(!Array.isArray(n)||0===n.length)return void localStorage.removeItem(e);this.config.debug&&console.warn(`ApplicationLogger: Resurrecting ${n.length} nuclear error(s) from previous session`);const a=Date.now(),c=n.filter(e=>a-(e.t||0)<s);if(0===c.length)return this.config.debug&&console.warn("ApplicationLogger: All nuclear errors expired, clearing"),void localStorage.removeItem(e);let l=0,h=0;for(const e of c)try{const t=e.m?String(e.m):"Nuclear error (catastrophic JavaScript failure)",r=new Error(t);r.name="NuclearError";const s=a-(e.t||a);this.captureException(r,{extra:{resurrected:!0,nuclear:!0,resurrectTimestamp:a,originalTimestamp:e.t||0,errorAge:Math.floor(s/1e3),filename:e.f||"unknown",lineno:e.l||0,colno:e.c||0,originalUrl:e.u||"unknown",sessionGap:!0}}),l++}catch(e){h++,this.config.debug&&console.error("ApplicationLogger: Failed to resurrect nuclear error",e)}0===h?(localStorage.removeItem(e),localStorage.removeItem(t),this.config.debug&&console.warn(`ApplicationLogger: Successfully resurrected ${l} nuclear error(s)`)):(localStorage.setItem(t,String(i+1)),this.config.debug&&console.warn(`ApplicationLogger: Resurrection partial success (${l} succeeded, ${h} failed), will retry on next load`))}catch(e){console.error("ApplicationLogger: Failed to process resurrected errors",e)}}processBufferedErrors(){try{if(!window._appLoggerBuffer||!Array.isArray(window._appLoggerBuffer.errors))return;const e=window._appLoggerBuffer.errors;if(0===e.length)return;this.config.debug&&console.warn(`ApplicationLogger: Processing ${e.length} buffered error(s)`),window._appLoggerBuffer.errors=[];let t=0,r=0;for(const s of e)try{if(!s||"object"!=typeof s){r++;continue}if("error"===s.type){const e=s.error&&s.error.message?String(s.error.message):s.message?String(s.message):"Unknown buffered error",r=new Error(e);s.error&&"object"==typeof s.error&&(s.error.name&&(r.name=String(s.error.name)),s.error.stack&&(r.stack=String(s.error.stack))),this.captureException(r,{extra:{buffered:!0,bufferedAt:s.timestamp||Date.now(),filename:s.filename||"unknown",lineno:"number"==typeof s.lineno?s.lineno:0,colno:"number"==typeof s.colno?s.colno:0}}),t++}else if("rejection"===s.type){const e=s.reason;let r;if(e&&"object"==typeof e){const t=e.message?String(e.message):"Unhandled promise rejection";r=new Error(t),r.name=e.name?String(e.name):"UnhandledRejection",e.stack&&(r.stack=String(e.stack))}else{const t=null!=e?String(e):"Unhandled promise rejection (undefined)";r=new Error(t),r.name="UnhandledRejection"}this.captureException(r,{extra:{buffered:!0,bufferedAt:s.timestamp||Date.now(),type:"unhandledrejection"}}),t++}else this.config.debug&&console.warn("ApplicationLogger: Unknown buffered item type:",s.type),r++}catch(e){r++,this.config.debug&&console.error("ApplicationLogger: Failed to process buffered item",e)}this.config.debug&&console.warn(`ApplicationLogger: Buffered errors processed (${t} succeeded, ${r} failed)`)}catch(e){console.error("ApplicationLogger: Failed to process buffered errors",e)}}countClickEvents(e){return Array.isArray(e)?e.filter(e=>e&&"click"===e.type).length:0}async captureException(e,t={}){try{const r=this.buildPayload(e,"error",t);if(this.errorDetector&&this.errorDetector.replayBuffer&&this.errorDetector.sessionManager)try{const t=await this.errorDetector.handleError(e,r);let s=null;if(t&&t.events&&t.events.length>0){const e=t.events.filter(e=>"before_error"===e.phase||"error"===e.phase);if(e.length>0){const r=this.countClickEvents(e);r>0?(s={sessionId:t.sessionId,events:e,phase:"pre-error"},this.config.debug&&console.warn("ApplicationLogger: Sending error with pre-error replay (phase 1)",{totalEvents:t.events.length,preErrorEvents:e.length,clickEvents:r,sessionId:s.sessionId})):this.config.debug&&console.warn("ApplicationLogger: No click events in replay buffer, skipping replay data",{totalEvents:e.length,bufferStats:this.errorDetector.replayBuffer.getStats()})}else this.config.debug&&console.warn("ApplicationLogger: No pre-error events in buffer",{totalEvents:t.events.length,bufferStats:this.errorDetector.replayBuffer.getStats()})}else this.config.debug&&console.warn("ApplicationLogger: No replay context from error detector",{hasContext:!!t,hasEvents:!(!t||!t.events),eventCount:t?.events?.length||0,bufferStats:this.errorDetector.replayBuffer.getStats()});await this.transport.send(r,s),"function"==typeof this.errorDetector.startRecoveryRecording&&this.errorDetector.startRecoveryRecording(e).catch(e=>{this.config.debug&&console.error("ApplicationLogger: Recovery recording failed",e)})}catch(e){this.config.debug&&console.error("ApplicationLogger: Session replay failed, sending error without replay",e),await this.transport.send(r)}else this.config.debug&&!this.errorDetector&&console.warn("ApplicationLogger: Session replay disabled (no error detector)"),await this.transport.send(r)}catch(e){console.error("Client: Failed to capture exception",e)}}captureMessage(e,t="info",r={}){const s=this.buildPayload(new Error(e),t,r);this.transport.send(s)}buildPayload(e,t,r={}){try{const s=this.parseStackTrace(e),i=s.length>0?s[0]:null,o={type:this.truncate(e.name||"Error",255),message:this.truncate(e.message||"Unknown error",1e3),file:this.truncate(i?.file||r.extra?.filename||"unknown",500),line:i?.line||r.extra?.lineno||1,stack_trace:s,level:t||"error",source:"frontend",environment:this.config.environment||"production",release:this.config.release||null,url:window.location.href,http_method:this.detectHttpMethod(),http_status_code:this.extractHttpStatusCode(e,r),session_hash:this.getSessionHash(),session_id:this.sessionManager?this.sessionManager.getSessionId():null,timestamp:(new Date).toISOString(),runtime:`JavaScript ${this.getBrowserInfo()}`,user_agent:navigator.userAgent,breadcrumbs:this.breadcrumbs.get(),context:{...this.extra,...r.extra},tags:{...this.tags,...r.tags}};return this.removeNullValues(o)}catch(e){return console.error("ApplicationLogger: Failed to build payload",e),{type:"Error",message:this.truncate("Failed to build error payload",1e3),file:"unknown",line:1,stack_trace:[],level:"error"}}}truncate(e,t){return e&&"string"==typeof e?e.length<=t?e:e.substring(0,t-3)+"...":e}parseStackTrace(e){if(!e.stack)return[{file:"unknown",line:1,function:"unknown"}];try{const t=e.stack.split("\n"),r=[];for(const e of t){const t=this.parseStackLine(e.trim());t&&r.push(t)}return r.length>0?r:[{file:"unknown",line:1,function:"unknown"}]}catch{return[{file:"unknown",line:1,function:"unknown"}]}}parseStackLine(e){if(!e)return null;let t=e.match(/at\s+(.+?)\s+\((.+?):(\d+):(\d+)\)/);return t?{function:t[1].trim(),file:t[2],line:parseInt(t[3],10),column:parseInt(t[4],10)}:(t=e.match(/at\s+(.+?):(\d+):(\d+)/),t?{function:"anonymous",file:t[1],line:parseInt(t[2],10),column:parseInt(t[3],10)}:(t=e.match(/(.+?)@(.+?):(\d+):(\d+)/),t?{function:t[1]||"anonymous",file:t[2],line:parseInt(t[3],10),column:parseInt(t[4],10)}:(t=e.match(/(?:(.+)@)?(.+?):(\d+)$/),t?{function:t[1]||"anonymous",file:t[2],line:parseInt(t[3],10),column:null}:(t=e.match(/at\s+(.+?)\s+\[(.+?):(\d+):(\d+)\]/),t?{function:t[1].trim(),file:t[2],line:parseInt(t[3],10),column:parseInt(t[4],10)}:null))))}detectHttpMethod(){try{const e=performance.getEntriesByType("navigation")[0];if(e&&e.type)return"GET"}catch{}return"GET"}extractHttpStatusCode(e,t={}){try{if(e.status&&"number"==typeof e.status)return e.status;if(t.httpStatusCode&&"number"==typeof t.httpStatusCode)return t.httpStatusCode;if(t.extra?.http_status_code&&"number"==typeof t.extra.http_status_code)return t.extra.http_status_code;if(t.extra?.httpStatusCode&&"number"==typeof t.extra.httpStatusCode)return t.extra.httpStatusCode;if(e.message){const t=e.message.match(/HTTP\s+(\d{3})/i);if(t){const e=parseInt(t[1],10);if(e>=100&&e<600)return e}}return null}catch{return null}}getBrowserInfo(){const e=navigator.userAgent;return e.includes("Chrome")&&!e.includes("Edge")?"Chrome":e.includes("Firefox")?"Firefox":e.includes("Safari")&&!e.includes("Chrome")?"Safari":e.includes("Edge")||e.includes("Edg/")?"Edge":e.includes("MSIE")||e.includes("Trident/")?"IE":"Unknown"}getSessionHash(){try{if(this.config.sessionHash)return this.config.sessionHash;if(this.cachedSessionHash)return this.cachedSessionHash;const e=this.getOrCreateSessionId();return this.djb2Hash(e)}catch{return null}}generateSessionId(){return crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}async initSessionHash(){try{const e=this.getOrCreateSessionId();if(crypto&&crypto.subtle){const t=(new TextEncoder).encode(e),r=await crypto.subtle.digest("SHA-256",t),s=Array.from(new Uint8Array(r));this.cachedSessionHash=s.map(e=>e.toString(16).padStart(2,"0")).join(""),this.config.debug&&console.warn("ApplicationLogger: Session hash initialized (Web Crypto)")}else this.cachedSessionHash=this.djb2Hash(e),this.config.debug&&console.warn("ApplicationLogger: Session hash initialized (fallback)")}catch(e){try{this.cachedSessionHash=this.djb2Hash(this.getOrCreateSessionId())}catch{this.config.debug&&console.error("ApplicationLogger: Failed to initialize session hash",e)}}}getOrCreateSessionId(){if("undefined"!=typeof sessionStorage){let e=sessionStorage.getItem("_app_logger_session_id");return e||(e=this.generateSessionId(),sessionStorage.setItem("_app_logger_session_id",e)),e}return this.generateSessionId()}djb2Hash(e){let t=5381;for(let r=0;r<e.length;r++)t=(t<<5)+t+e.charCodeAt(r);return Math.abs(t).toString(16).padStart(64,"0")}removeNullValues(e){const t={};for(const[r,s]of Object.entries(e))null!=s&&(t[r]=s);return t}setUser(e){this.userContext=e}setTags(e){this.tags={...this.tags,...e}}setExtra(e){this.extra={...this.extra,...e}}flushBeaconErrors(){try{if(!navigator.sendBeacon)return;const e=this.transport.getStats();if(0===e.storedErrors&&0===e.queueSize)return;this.transport.flushWithBeacon()}catch{}}}class t{constructor(e=50,t=null){this.breadcrumbs=[],this.maxBreadcrumbs=e,this.installed=!1,this.errorCaptureCallback=t}getClassName(e){return e.className?"object"==typeof e.className&&void 0!==e.className.baseVal?e.className.baseVal:e.className:""}install(){if(this.installed)return;this.installed=!0,document.addEventListener("click",e=>{const t=e.target,r=t.tagName.toLowerCase();let s=`Clicked ${r}`;const i=this.getClassName(t);if(t.id)s+=`#${t.id}`;else if(i){const e=i.split(" ")[0];e&&(s+=`.${e}`)}this.add({type:"ui",category:"click",message:s,data:{tag:r,id:t.id,class:i}})},!0);const e=history.pushState,t=history.replaceState;history.pushState=(...t)=>(this.add({type:"navigation",category:"navigation",message:`Navigated to ${t[2]}`,data:{to:t[2]}}),e.apply(history,t)),history.replaceState=(...e)=>(this.add({type:"navigation",category:"navigation",message:`Replaced state ${e[2]}`,data:{to:e[2]}}),t.apply(history,e)),this.wrapConsole(),this.wrapFetch()}add(e){this.breadcrumbs.push({timestamp:(new Date).toISOString(),level:e.level||"info",...e}),this.breadcrumbs.length>this.maxBreadcrumbs&&this.breadcrumbs.shift()}get(){return this.breadcrumbs}clear(){this.breadcrumbs=[]}wrapConsole(){["log","info","warn","error","debug"].forEach(e=>{const t=console[e];"function"==typeof t&&(console[e]=(...r)=>{if("error"===e&&this.errorCaptureCallback)try{const e=r.find(e=>e instanceof Error);e&&"function"==typeof this.errorCaptureCallback&&this.errorCaptureCallback(e,{extra:{consoleError:!0,consoleMessage:r.filter(e=>!(e instanceof Error)).map(e=>String(e)).join(" ")}})}catch(e){if("function"==typeof t)try{t.call(console,"ApplicationLogger: Failed to auto-capture error:",e)}catch{}}let s;try{s=t.apply(console,r)}catch{}try{const t=r.map(e=>{if(null===e)return"null";if(void 0===e)return"undefined";if(e instanceof Error)return`${e.name}: ${e.message}`;if("object"==typeof e)try{return JSON.stringify(e)}catch{return Object.prototype.toString.call(e)}return String(e)});this.add({type:"console",category:"console",message:t.join(" "),level:"log"===e?"info":e,data:{arguments:t}})}catch{}return s})})}wrapFetch(){const e=window.fetch;window.fetch=async(...t)=>{const r="string"==typeof t[0]?t[0]:t[0].url,s=t[1]?.method||"GET",i=Date.now();try{const o=await e.apply(window,t),n=Date.now()-i;return this.add({type:"http",category:"fetch",message:`${s} ${r}`,data:{url:r,method:s,status_code:o.status,duration:n},level:o.ok?"info":"warning"}),o}catch(e){const t=Date.now()-i;throw this.add({type:"http",category:"fetch",message:`${s} ${r} failed`,data:{url:r,method:s,error:e.message,duration:t},level:"error"}),e}}}}class r{static STATE_CLOSED="closed";static STATE_OPEN="open";static STATE_HALF_OPEN="half_open";constructor(e={}){this.failureThreshold=e.failureThreshold||5,this.timeout=e.timeout||6e4,this.storageKey="app_logger_circuit_breaker",this.loadState()}isOpen(){return this.state===r.STATE_OPEN&&this.shouldAttemptReset()&&this.halfOpen(),this.state===r.STATE_OPEN}isHalfOpen(){return this.state===r.STATE_HALF_OPEN}recordSuccess(){this.state===r.STATE_HALF_OPEN?this.close():this.state===r.STATE_CLOSED&&(this.failureCount=0,this.saveState())}recordFailure(){this.state===r.STATE_HALF_OPEN?this.open():this.state===r.STATE_CLOSED&&(this.failureCount++,this.failureCount>=this.failureThreshold?this.open():this.saveState())}getState(){return{state:this.state,failureCount:this.failureCount,openedAt:this.openedAt}}reset(){this.close()}close(){this.state=r.STATE_CLOSED,this.failureCount=0,this.openedAt=null,this.saveState()}open(){this.state=r.STATE_OPEN,this.openedAt=Date.now(),this.saveState()}halfOpen(){this.state=r.STATE_HALF_OPEN,this.saveState()}shouldAttemptReset(){return!!this.openedAt&&Date.now()-this.openedAt>=this.timeout}loadState(){try{const e=sessionStorage.getItem(this.storageKey);if(e){const t=JSON.parse(e);this.state=t.state||r.STATE_CLOSED,this.failureCount=t.failureCount||0,this.openedAt=t.openedAt||null}else this.state=r.STATE_CLOSED,this.failureCount=0,this.openedAt=null}catch{this.state=r.STATE_CLOSED,this.failureCount=0,this.openedAt=null}}saveState(){try{const e={state:this.state,failureCount:this.failureCount,openedAt:this.openedAt};sessionStorage.setItem(this.storageKey,JSON.stringify(e))}catch{}}}class s{constructor(e={}){this.storageKey="app_logger_queue",this.maxSize=e.maxSize||50,this.maxAge=e.maxAge||864e5}enqueue(e){try{const t=this.getQueue(),r={payload:e,timestamp:Date.now()};t.push(r),t.length>this.maxSize&&t.shift(),this.saveQueue(t)}catch(e){console.warn("ApplicationLogger: Failed to queue error",e)}}dequeue(){try{const e=this.getQueue();if(0===e.length)return null;const t=e.shift();return this.saveQueue(e),t.payload}catch{return null}}getAll(){return this.getQueue().map(e=>e.payload)}size(){return this.getQueue().length}clear(){try{localStorage.removeItem(this.storageKey)}catch{}}getQueue(){try{const e=localStorage.getItem(this.storageKey);if(!e)return[];const t=JSON.parse(e);if(!Array.isArray(t))return[];const r=Date.now(),s=t.filter(e=>e.timestamp&&r-e.timestamp<this.maxAge);return s.length!==t.length&&this.saveQueue(s),s}catch{return[]}}saveQueue(e){try{localStorage.setItem(this.storageKey,JSON.stringify(e))}catch(t){if("QuotaExceededError"===t.name){const t=Math.floor(e.length/2),r=e.slice(-t);try{localStorage.setItem(this.storageKey,JSON.stringify(r))}catch{this.clear()}}}}}class i{constructor(e={}){this.maxTokens=e.maxTokens||10,this.refillRate=e.refillRate||1,this.tokens=this.maxTokens,this.lastRefill=Date.now()}isAllowed(){return this.refillTokens(),this.tokens>0}consume(){return!!this.isAllowed()&&(this.tokens--,!0)}refillTokens(){const e=Date.now(),t=(e-this.lastRefill)/1e3,r=Math.floor(t*this.refillRate);r>0&&(this.tokens=Math.min(this.maxTokens,this.tokens+r),this.lastRefill=e)}getTokens(){return this.refillTokens(),this.tokens}reset(){this.tokens=this.maxTokens,this.lastRefill=Date.now()}}class o{constructor(e){this.config=e,this.apiKey=e.apiKey,this.dsn=this.parseDsn(e.dsn),this.queue=[],this.sending=!1,this.circuitBreaker=new r({failureThreshold:e.circuitBreakerFailureThreshold??5,timeout:e.circuitBreakerTimeoutMs??6e4}),this.storageQueue=new s({maxSize:e.storageQueueMaxSize??50,maxAge:e.storageQueueMaxAgeMs??864e5}),this.rateLimiter=new i({maxTokens:e.rateLimiterMaxTokens??10,refillRate:e.rateLimiterRefillRate??.167}),this.recentErrors=new Map,this.deduplicationWindow=e.deduplicationWindowMs??5e3,this.flushStoredErrors()}parseDsn(e){if(!e)throw new Error("DSN is required");try{const t=new URL(e),r=t.pathname.replace(/^\//,"");if(!r)throw new Error("DSN must include a project ID in the path");return{protocol:t.protocol.replace(":",""),host:t.host,projectId:r,endpoint:`${t.protocol}//${t.host}/api/errors/ingest`}}catch(e){throw new Error(`Invalid DSN format: ${e.message}. Expected: https://host/project-id`)}}async send(e,t=null){try{let r=e;t&&(r={...e,replay_session_id:t.sessionId,replay_data:t.events},this.config.debug&&console.warn("ApplicationLogger: Sending error with replay data",{sessionId:t.sessionId,eventCount:t.events?.length||0}));const s=this.scrubSensitiveData(r);if(this.isDuplicate(s))return void(this.config.debug&&console.warn("ApplicationLogger: Duplicate error ignored"));if(!this.rateLimiter.consume())return this.config.debug&&console.warn("ApplicationLogger: Rate limit exceeded, error queued"),void this.storageQueue.enqueue(s);this.queue.push(s),this.sending||await this.processQueue()}catch(e){console.error("ApplicationLogger: Send failed",e)}}async sendRecoverySession(e,t=!1){try{const r=`${this.dsn.protocol}://${this.dsn.host}/api/errors/recovery-session`;if(this.config.debug&&console.warn("ApplicationLogger: Sending recovery session",{sessionId:e.sessionId,eventCount:e.events?.length||0,method:t?"sendBeacon":"fetch"}),t&&navigator.sendBeacon){const t={...e,apiKey:this.apiKey},s=new Blob([JSON.stringify(t)],{type:"application/json"});if(navigator.sendBeacon(r,s))return this.config.debug&&console.warn("ApplicationLogger: Recovery session queued via sendBeacon"),{success:!0,method:"beacon"};throw new Error("sendBeacon failed (queue full or too large)")}const s=new AbortController,i=setTimeout(()=>s.abort(),5e3),o=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json","X-Api-Key":this.apiKey,"User-Agent":"ApplicationLogger-JS-SDK/1.0"},body:JSON.stringify(e),signal:s.signal});if(clearTimeout(i),!o.ok)throw new Error(`Recovery session send failed: ${o.status}`);return this.config.debug&&console.warn("ApplicationLogger: Recovery session sent successfully"),o.json()}catch(t){console.error("ApplicationLogger: Failed to send recovery session",t);try{this.storageQueue.enqueue({type:"recovery",payload:e})}catch(e){console.error("ApplicationLogger: Failed to queue recovery session",e)}throw t}}async processQueue(){if(0!==this.queue.length&&!this.sending){for(this.sending=!0;this.queue.length>0;){const e=this.queue.shift();try{await this.sendToApi(e),this.config.debug&&console.warn("ApplicationLogger: Error sent successfully")}catch{}}this.sending=!1}}async sendToApi(e,t=0){if(this.circuitBreaker.isOpen())return this.config.debug&&console.warn("ApplicationLogger: Circuit breaker is open, error queued to storage"),void this.storageQueue.enqueue(e);const r=new AbortController,s=setTimeout(()=>r.abort(),3e3);try{const t=await fetch(this.dsn.endpoint,{method:"POST",headers:{"Content-Type":"application/json","X-Api-Key":this.apiKey,"User-Agent":"ApplicationLogger-JS-SDK/1.0"},body:JSON.stringify(e),signal:r.signal});if(clearTimeout(s),!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return this.circuitBreaker.recordSuccess(),this.flushStoredErrors(),t.json()}catch(r){if(clearTimeout(s),"AbortError"===r.name)return this.circuitBreaker.recordFailure(),this.config.debug&&console.error("ApplicationLogger: Request timeout"),void this.storageQueue.enqueue(e);if(t<2){const r=1e3*Math.pow(2,t);return await this.delay(r),this.sendToApi(e,t+1)}this.circuitBreaker.recordFailure(),this.config.debug&&console.error("ApplicationLogger: Max retries reached",r),this.storageQueue.enqueue(e)}}isDuplicate(e){try{const t=JSON.stringify({type:e.type,message:e.message,stack:e.stack_trace?.slice(0,3)}),r=this.simpleHash(t);if(this.recentErrors.has(r))return!0;this.recentErrors.set(r,Date.now());const s=Date.now();for(const[e,t]of this.recentErrors)s-t>this.deduplicationWindow&&this.recentErrors.delete(e);return!1}catch{return!1}}simpleHash(e){let t=0;for(let r=0;r<e.length;r++){t=(t<<5)-t+e.charCodeAt(r),t&=t}return t.toString()}async flushStoredErrors(){try{const e=this.storageQueue.size();if(0===e)return;this.config.debug&&console.warn(`ApplicationLogger: Flushing ${e} stored errors`);const t=Math.min(e,5);for(let e=0;e<t;e++){const e=this.storageQueue.dequeue();e&&this.queue.push(e)}!this.sending&&this.queue.length>0&&await this.processQueue()}catch(e){this.config.debug&&console.error("ApplicationLogger: Flush failed",e)}}delay(e){return new Promise(t=>setTimeout(t,e))}scrubSensitiveData(e){const t=[...this.config.scrubFields||[],"password","passwd","pwd","secret","api_key","apikey","token","auth","authorization","private_key","access_token","refresh_token"];let r;try{r=JSON.parse(JSON.stringify(e))}catch{r=this.removeCircularReferences(e)}const s=e=>{if(!e||"object"!=typeof e)return e;for(const r in e)if(Object.prototype.hasOwnProperty.call(e,r)){t.some(e=>r.toLowerCase().includes(e.toLowerCase()))?e[r]="[REDACTED]":"object"==typeof e[r]&&s(e[r])}return e};return s(r)}removeCircularReferences(e,t=new WeakSet){if(null===e||"object"!=typeof e)return e;if(t.has(e))return"[Circular Reference]";if(t.add(e),Array.isArray(e))return e.map(e=>this.removeCircularReferences(e,t));const r={};for(const s in e)if(Object.prototype.hasOwnProperty.call(e,s))try{r[s]=this.removeCircularReferences(e[s],t)}catch{r[s]="[Error accessing property]"}return r}async sendSessionEvent(e,t){if(e&&t)try{const r=`${this.dsn.protocol}://${this.dsn.host}/api/v1/sessions/${e}/events`,s=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json","X-Api-Key":this.apiKey,"User-Agent":"ApplicationLogger-JS-SDK/1.0"},body:JSON.stringify(t)});if(!s.ok)throw new Error(`HTTP ${s.status}`);return s.json()}catch(e){this.config.debug&&console.error("ApplicationLogger: Failed to send session event",e)}}async sendReplayClicks(e,t){if(e&&t&&0!==t.length)try{const r=`${this.dsn.protocol}://${this.dsn.host}/api/v1/sessions/${e}/replay`,s=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json","X-Api-Key":this.apiKey,"User-Agent":"ApplicationLogger-JS-SDK/1.0"},body:JSON.stringify({clicks:t})});if(!s.ok)throw new Error(`HTTP ${s.status}`);return this.config.debug&&console.warn(`ApplicationLogger: Sent ${t.length} heatmap clicks`),s.json()}catch(e){this.config.debug&&console.error("ApplicationLogger: Failed to send heatmap data",e)}}getStats(){return{queueSize:this.queue.length,storedErrors:this.storageQueue.size(),circuitBreaker:this.circuitBreaker.getState(),rateLimitTokens:this.rateLimiter.getTokens()}}flushWithBeacon(){try{const e=this.storageQueue.getAll(),t=[...this.queue,...e];if(0===t.length)return;const r=t.slice(-10),s={dsn:this.config.dsn,errors:r},i=new Blob([JSON.stringify(s)],{type:"application/json"});navigator.sendBeacon(this.dsn.endpoint,i)&&(this.storageQueue.clear(),this.queue=[],this.config.debug&&console.warn(`ApplicationLogger: Flushed ${r.length} errors via Beacon API`))}catch(e){this.config.debug&&console.error("ApplicationLogger: Beacon flush failed",e)}}}class n{constructor(e={}){this.maxDepth=e.maxDepth||10,this.minSize=e.minSize||5,this.skipInvisible=!1!==e.skipInvisible,this.captureColors=!1!==e.captureColors,this.debug=e.debug||!1,this.stats={totalElements:0,skippedInvisible:0,skippedTiny:0,skippedNonVisual:0,maxDepthReached:0}}serialize(e=document.body){this.stats={totalElements:0,skippedInvisible:0,skippedTiny:0,skippedNonVisual:0,maxDepthReached:0};const t=performance.now();try{const r={width:window.innerWidth,height:window.innerHeight,scrollX:window.scrollX,scrollY:window.scrollY},s=this.serializeElement(e,0),i=performance.now()-t;return this.debug&&console.warn("DOM Serialization Stats:",{...this.stats,elapsedMs:i.toFixed(2)}),{viewport:r,tree:s,timestamp:Date.now(),stats:this.stats}}catch(e){return console.error("DOM serialization failed:",e),null}}serializeElement(e,t){if(t>=this.maxDepth)return this.stats.maxDepthReached++,null;if(this.isNonVisualElement(e))return this.stats.skippedNonVisual++,null;const r=window.getComputedStyle(e);if(this.skipInvisible&&this.isInvisible(e,r))return this.stats.skippedInvisible++,null;const s=e.getBoundingClientRect();if(s.width<this.minSize||s.height<this.minSize)return this.stats.skippedTiny++,null;this.stats.totalElements++;const i={type:e.tagName.toLowerCase(),bounds:{x:Math.round(s.left+window.scrollX),y:Math.round(s.top+window.scrollY),width:Math.round(s.width),height:Math.round(s.height)},bgColor:this.captureColors?this.extractBackgroundColor(r):null,layout:this.detectLayoutType(r),isInteractive:this.isInteractive(e),isText:this.isTextContainer(e)},o=[],n=Array.from(e.children);for(const e of n){const r=this.serializeElement(e,t+1);r&&o.push(r)}return o.length>0&&(i.children=o),i}isNonVisualElement(e){return["SCRIPT","STYLE","LINK","META","NOSCRIPT","TITLE","HEAD","BASE"].includes(e.tagName)}isInvisible(e,t){if("none"===t.display)return!0;if("hidden"===t.visibility)return!0;if(0===parseFloat(t.opacity))return!0;const r=e.getBoundingClientRect();return r.bottom<-1e3||r.top>window.innerHeight+1e3||r.right<-1e3||r.left>window.innerWidth+1e3}extractBackgroundColor(e){try{const t=e.backgroundColor;return t&&"transparent"!==t&&"rgba(0, 0, 0, 0)"!==t?this.rgbToHex(t):null}catch{return null}}rgbToHex(e){try{const t=e.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/);if(!t)return null;const r=parseInt(t[1],10),s=parseInt(t[2],10),i=parseInt(t[3],10),o=e=>{const t=e.toString(16);return 1===t.length?"0"+t:t};return`#${o(r)}${o(s)}${o(i)}`}catch{return null}}detectLayoutType(e){const t=e.display;return t.includes("flex")?"flex":t.includes("grid")?"grid":"inline"===t||"inline-block"===t?"inline":"block"}isInteractive(e){if(["A","BUTTON","INPUT","SELECT","TEXTAREA","LABEL"].includes(e.tagName))return!0;if(e.onclick||e.hasAttribute("onclick"))return!0;return"pointer"===window.getComputedStyle(e).cursor}isTextContainer(e){return["P","SPAN","H1","H2","H3","H4","H5","H6","LI","LABEL","TD","TH","CODE","PRE"].includes(e.tagName)}getStats(){return{...this.stats}}estimateSize(e){try{return JSON.stringify(e).length}catch{return 0}}compress(e){const t=e=>{if(Array.isArray(e))return e.map(t);if(null!==e&&"object"==typeof e){const r={};for(const s in e)null!==e[s]&&void 0!==e[s]&&(r[s]=t(e[s]));return r}return e};return t(e)}}class a{constructor(e={}){this.serializer=new n(e),this.throttleMs=e.throttleMs||1e3,this.lastCaptureTime=0,this.pendingCapture=null}serialize(e){const t=Date.now(),r=t-this.lastCaptureTime;if(r<this.throttleMs){if(!this.pendingCapture){const e=this.throttleMs-r;this.pendingCapture=setTimeout(()=>{this.pendingCapture=null,this.lastCaptureTime=Date.now()},e)}return null}return this.lastCaptureTime=t,this.serializer.serialize(e)}getStats(){return this.serializer.getStats()}clearThrottle(){this.pendingCapture&&(clearTimeout(this.pendingCapture),this.pendingCapture=null)}}class c{constructor(e,t,r){this.replayBuffer=e,this.sessionManager=t,this.config=r,this.isInstalled=!1;const s=Math.max(r.snapshotThrottleMs||1e3,500);this.domSerializer=new a({maxDepth:10,minSize:5,skipInvisible:!0,captureColors:!0,throttleMs:s,maxSize:r.maxSnapshotSize||1048576,debug:r.debug||!1}),this.domCaptureStats={total:0,throttled:0,captured:0,errors:0},this.lastClickTime=0,this.clickDebounceMs=Math.max(r.clickDebounceMs||1e3,100),this.debounceStats={totalClicks:0,debouncedClicks:0}}install(){if(!this.isInstalled)try{document.addEventListener("click",e=>{this.captureClick(e)},!0),this.isInstalled=!0,this.config.debug&&console.warn("ClickTracker: Installed (buffer-based recording)")}catch(e){console.error("ClickTracker: Failed to install",e)}}captureClick(e){try{const t=Date.now();if(this.debounceStats.totalClicks++,t-this.lastClickTime<this.clickDebounceMs)return this.debounceStats.debouncedClicks++,void(this.config.debug&&console.warn("ClickTracker: Click debounced",{timeSinceLastClick:t-this.lastClickTime,debounceThreshold:this.clickDebounceMs}));this.lastClickTime=t;const r={type:"click",url:window.location.href,timestamp:Date.now(),clickData:{x:e.pageX,y:e.pageY,viewportWidth:window.innerWidth,viewportHeight:window.innerHeight,elementSelector:this.generateSelector(e.target)},sessionId:this.sessionManager.getSessionId()};this.domCaptureStats.total++;try{const e=this.domSerializer.serialize();if(e){if(r.domSnapshot=e,this.domCaptureStats.captured++,this.config.debug){const t=this.domSerializer.serializer.estimateSize(e);console.warn("ClickTracker: DOM snapshot captured",{elements:e.stats?.totalElements||0,sizeBytes:t,sizeKB:(t/1024).toFixed(2)})}}else this.domCaptureStats.throttled++,this.config.debug&&console.warn("ClickTracker: DOM snapshot throttled")}catch(e){this.domCaptureStats.errors++,this.config.debug&&console.error("ClickTracker: DOM serialization failed",e)}!this.replayBuffer.addEvent(r)&&this.config.debug&&console.warn("ClickTracker: Failed to add click to buffer")}catch(e){console.error("ClickTracker: Failed to capture click",e)}}generateSelector(e){if(!e||e===document)return"";try{const t=[];let r=e,s=0;const i=5;for(;r&&r!==document&&s<i;){let e=r.tagName.toLowerCase();if(r.id&&!this.containsSensitiveData(r.id)){e+=`#${CSS.escape(r.id)}`,t.unshift(e);break}const i=this.getCleanClasses(r);i.length>0&&(e+=`.${i.join(".")}`);const o=r.parentElement?Array.from(r.parentElement.children).filter(e=>e.tagName===r.tagName):[];if(o.length>1){e+=`:nth-child(${o.indexOf(r)+1})`}t.unshift(e),r=r.parentElement,s++}return t.join(" > ")}catch{return e.tagName?e.tagName.toLowerCase():"unknown"}}getCleanClasses(e){if(!e.classList||0===e.classList.length)return[];return Array.from(e.classList).filter(e=>!e.match(/^(active|hover|focus|disabled|hidden|show)$/)&&(!e.match(/^(ng-|v-|data-|_)/)&&!this.containsSensitiveData(e))).map(e=>CSS.escape(e)).slice(0,3)}containsSensitiveData(e){return[/user[-_]?id/i,/email/i,/token/i,/session/i,/auth/i,/key/i,/\d{10,}/].some(t=>t.test(e))}getDOMCaptureStats(){return{...this.domCaptureStats,serializerStats:this.domSerializer.getStats()}}getDebounceStats(){return{...this.debounceStats,debounceRate:this.debounceStats.totalClicks>0?(this.debounceStats.debouncedClicks/this.debounceStats.totalClicks*100).toFixed(2)+"%":"0%",clickDebounceMs:this.clickDebounceMs}}cleanup(){try{this.domSerializer&&this.domSerializer.clearThrottle&&this.domSerializer.clearThrottle(),this.config.debug&&console.warn("ClickTracker: Cleanup complete")}catch(e){console.error("ClickTracker: Cleanup failed",e)}}}class l{constructor(e={}){this.config={bufferBeforeErrorSeconds:Math.min(e.bufferBeforeErrorSeconds||30,60),bufferBeforeErrorClicks:Math.min(e.bufferBeforeErrorClicks||10,15),bufferAfterErrorSeconds:Math.min(e.bufferAfterErrorSeconds||30,60),bufferAfterErrorClicks:Math.min(e.bufferAfterErrorClicks||10,15),maxBufferSizeMB:Math.min(e.maxBufferSizeMB||5,20),debug:e.debug||!1},this.buffer=[],this.isRecordingAfterError=!1,this.recordingStartedAt=null,this.errorOccurredAt=null,this.postErrorEventCount=0,this.stats={totalEvents:0,eventsDropped:0,bufferFullCount:0,currentBufferSize:0},this.config.debug&&console.warn("ReplayBuffer initialized with config:",this.config)}addEvent(e){try{return e&&e.timestamp?(e.phase=this.isRecordingAfterError?"after_error":"before_error",e.capturedAt=Date.now(),this.buffer.push(e),this.stats.totalEvents++,this.isRecordingAfterError?(this.postErrorEventCount++,this.shouldStopRecording()&&this.stopRecording()):this.pruneOldEvents(),this.updateStats(),!0):(console.warn("ReplayBuffer: Invalid event (missing timestamp)"),!1)}catch(e){return console.error("ReplayBuffer: Failed to add event:",e),this.stats.eventsDropped++,!1}}startRecordingAfterError(e){try{this.errorOccurredAt=e.timestamp||Date.now(),this.postErrorEventCount=0,this.buffer.push({type:"error",phase:"error",timestamp:this.errorOccurredAt,capturedAt:Date.now(),url:window.location.href,errorContext:e}),this.stats.totalEvents++,this.isRecordingAfterError=!0,this.config.debug&&console.warn("ReplayBuffer: Started recording after error",{errorId:e.errorId,bufferSize:this.buffer.length,willRecordFor:`${this.config.bufferAfterErrorSeconds}s or ${this.config.bufferAfterErrorClicks} clicks`})}catch(e){console.error("ReplayBuffer: Failed to start post-error recording:",e)}}stopRecording(){try{if(!this.isRecordingAfterError)return;this.isRecordingAfterError=!1,this.config.debug&&console.warn("ReplayBuffer: Stopped recording after error",{totalEvents:this.buffer.length,postErrorEvents:this.postErrorEventCount})}catch(e){console.error("ReplayBuffer: Failed to stop recording:",e)}}shouldStopRecording(){if(!this.isRecordingAfterError||!this.errorOccurredAt)return!1;const e=(Date.now()-this.errorOccurredAt)/1e3;return e>=this.config.bufferAfterErrorSeconds?(this.config.debug&&console.warn(`ReplayBuffer: Time limit reached (${e.toFixed(1)}s)`),!0):this.postErrorEventCount>=this.config.bufferAfterErrorClicks&&(this.config.debug&&console.warn(`ReplayBuffer: Click limit reached (${this.postErrorEventCount} clicks)`),!0)}pruneOldEvents(){try{const e=Date.now()-1e3*this.config.bufferBeforeErrorSeconds,t=this.buffer.filter(t=>t.capturedAt>=e||"error"===t.phase),r=t.filter(e=>"click"===e.type),s=t.filter(e=>"click"!==e.type),i=r.slice(-this.config.bufferBeforeErrorClicks);if(this.buffer=[...s,...i].sort((e,t)=>e.capturedAt-t.capturedAt),this.buffer.length<t.length){const e=t.length-this.buffer.length;this.stats.eventsDropped+=e}}catch(e){console.error("ReplayBuffer: Failed to prune old events:",e)}}getEvents(){return[...this.buffer]}getEventsByPhase(e){return this.buffer.filter(t=>t.phase===e)}clear(){try{this.buffer=[],this.isRecordingAfterError=!1,this.recordingStartedAt=null,this.errorOccurredAt=null,this.postErrorEventCount=0,this.config.debug&&console.warn("ReplayBuffer: Cleared")}catch(e){console.error("ReplayBuffer: Failed to clear buffer:",e)}}isRecording(){return this.isRecordingAfterError}getStats(){return{...this.stats,bufferLength:this.buffer.length,isRecording:this.isRecordingAfterError,postErrorEventCount:this.postErrorEventCount}}updateStats(){try{const e=this.estimateBufferSize();this.stats.currentBufferSize=e;e>1024*this.config.maxBufferSizeMB*1024&&(this.stats.bufferFullCount++,this.buffer=this.buffer.slice(-Math.floor(this.buffer.length/2)))}catch(e){console.error("ReplayBuffer: Failed to update stats:",e)}}estimateBufferSize(){try{return JSON.stringify(this.buffer).length}catch{return 0}}serialize(){return{buffer:this.buffer,isRecordingAfterError:this.isRecordingAfterError,errorOccurredAt:this.errorOccurredAt,postErrorEventCount:this.postErrorEventCount,stats:this.stats}}deserialize(e){try{if(!e||"object"!=typeof e)return this.config.debug&&console.warn("ReplayBuffer: No data to deserialize"),!1;this.buffer=Array.isArray(e.buffer)?e.buffer:[],this.isRecordingAfterError=!!e.isRecordingAfterError,this.errorOccurredAt=e.errorOccurredAt||null,this.postErrorEventCount=e.postErrorEventCount||0,e.stats&&"object"==typeof e.stats&&(this.stats={...this.stats,...e.stats});let t=0;if(this.buffer=this.buffer.map(e=>e.phase?e:(t++,{...e,phase:"before_error"})),this.config.debug){const e=this.buffer.reduce((e,t)=>(e[t.phase]=(e[t.phase]||0)+1,e),{});console.warn("ReplayBuffer: Deserialized from localStorage",{totalEvents:this.buffer.length,migratedEvents:t,phaseBreakdown:e,isRecording:this.isRecordingAfterError,byteSize:this.estimateBufferSize()})}return!0}catch(e){return console.error("ReplayBuffer: Failed to deserialize:",e),!1}}}class h{constructor(e,t,r,s=null,i={}){this.replayBuffer=e,this.sessionManager=t,this.onErrorDetected=r,this.transport=s,this.config={debug:i.debug||!1,ignoreErrors:i.ignoreErrors||[]},this.isInstalled=!1,this.recentErrors=new Set,this.recentErrorsCleanupInterval=null,this.isRecordingRecovery=!1,this.recoveryRecordingCleanup=null,this.stats={errorsDetected:0,errorsIgnored:0,replaysCaptured:0,duplicatesPrevented:0,recoveryRecordingsStarted:0,recoveryRecordingsCancelled:0},this.config.debug&&console.warn("ErrorDetector initialized")}install(){if(this.isInstalled)console.warn("ErrorDetector: Already installed");else try{this.recentErrorsCleanupInterval=setInterval(()=>{this.recentErrors.clear()},6e4),this.isInstalled=!0,this.config.debug&&console.warn("ErrorDetector: Installed")}catch(e){console.error("ErrorDetector: Failed to install:",e)}}uninstall(){try{this.recentErrorsCleanupInterval&&(clearInterval(this.recentErrorsCleanupInterval),this.recentErrorsCleanupInterval=null),this.isInstalled=!1,this.config.debug&&console.warn("ErrorDetector: Uninstalled")}catch(e){console.error("ErrorDetector: Failed to uninstall:",e)}}async handleError(e,t){try{if(this.stats.errorsDetected++,this.shouldIgnoreError(e))return this.stats.errorsIgnored++,this.config.debug&&console.warn("ErrorDetector: Error ignored:",e.message),null;const r=this.generateErrorFingerprint(e);if(this.recentErrors.has(r))return this.stats.duplicatesPrevented++,this.config.debug&&console.warn("ErrorDetector: Duplicate error prevented"),null;this.recentErrors.add(r);const s={errorId:null,message:e.message||"Unknown error",type:e.name||"Error",timestamp:Date.now(),stack:e.stack||"",url:window.location.href};this.replayBuffer.startRecordingAfterError(s);const i=this.replayBuffer.getEvents();return this.config.debug&&console.warn("ErrorDetector: Replay captured",{errorMessage:s.message,eventCount:i.length,beforeError:this.replayBuffer.getEventsByPhase("before_error").length,afterError:this.replayBuffer.getEventsByPhase("after_error").length}),this.stats.replaysCaptured++,this.onErrorDetected&&await this.onErrorDetected(s,i,t),{errorContext:s,events:i,sessionId:this.sessionManager.getSessionId(),stats:this.replayBuffer.getStats()}}catch(e){return console.error("ErrorDetector: Failed to handle error:",e),null}}shouldIgnoreError(e){try{if(!e||!e.message)return!1;const t=e.message.toLowerCase();for(const e of this.config.ignoreErrors)if(t.includes(e.toLowerCase()))return!0;const r=["script error","network error","loading chunk","dynamically imported module"];for(const e of r)if(t.includes(e))return!0;return!1}catch{return!1}}generateErrorFingerprint(e){try{const t=e.message||"",r=e.stack||"";return`${t}:${r.split("\n")[1]||""}`}catch{return`${Date.now()}:${Math.random()}`}}async startRecoveryRecording(e){try{if(this.isRecordingRecovery&&(this.config.debug&&console.warn("ErrorDetector: Already recording recovery, cleaning up previous recording"),this.recoveryRecordingCleanup&&this.recoveryRecordingCleanup(),this.stats.recoveryRecordingsCancelled++),!this.replayBuffer||!this.sessionManager)return void console.error("ErrorDetector: Cannot start recovery recording - missing dependencies");if(!e||"object"!=typeof e)return void console.error("ErrorDetector: Invalid error object for recovery recording");this.isRecordingRecovery=!0,this.stats.recoveryRecordingsStarted++,this.config.debug&&console.warn("ErrorDetector: Starting recovery recording (phase 2)");const t={errorId:null,message:e.message||"Unknown error",type:e.name||"Error",timestamp:Date.now(),url:window.location.href};return"function"!=typeof this.replayBuffer.startRecordingAfterError?(console.error("ErrorDetector: Buffer missing startRecordingAfterError method"),void(this.isRecordingRecovery=!1)):(this.replayBuffer.startRecordingAfterError(t),new Promise(e=>{let r=null,s=null,i=null;const o=()=>{r&&(clearInterval(r),r=null),s&&(window.removeEventListener("beforeunload",s),s=null),i&&(document.removeEventListener("visibilitychange",i),i=null),this.isRecordingRecovery=!1,this.recoveryRecordingCleanup=null};this.recoveryRecordingCleanup=o;const n=(r="unknown")=>{this.config.debug&&console.warn(`ErrorDetector: Finishing recovery recording (reason: ${r})`),o();let s=[];if(this.replayBuffer&&"function"==typeof this.replayBuffer.getEventsByPhase&&(s=this.replayBuffer.getEventsByPhase("after_error")||[]),s.length>0){const e="page-unload"===r||"page-hidden"===r;this.sendRecoverySession(t,s,e)}else this.config.debug&&console.warn("ErrorDetector: No recovery events captured");e()};r=setInterval(()=>{try{if(!this.replayBuffer||"function"!=typeof this.replayBuffer.shouldStopRecording)return void n("buffer-unavailable");this.replayBuffer.shouldStopRecording()&&n("limit-reached")}catch(e){console.error("ErrorDetector: Error in recovery check interval",e),n("check-error")}},1e3),s=()=>{n("page-unload")},window.addEventListener("beforeunload",s,{once:!0}),i=()=>{"hidden"===document.visibilityState&&n("page-hidden")},document.addEventListener("visibilitychange",i,{once:!0}),setTimeout(()=>{this.isRecordingRecovery&&(this.config.debug&&console.warn("ErrorDetector: Recovery recording safety timeout (2 minutes)"),n("safety-timeout"))},12e4)}))}catch(e){console.error("ErrorDetector: Failed to start recovery recording",e),this.isRecordingRecovery=!1,this.recoveryRecordingCleanup=null}}sendRecoverySession(e,t,r=!1){try{if(0===t.length)return;if(0===t.filter(e=>e&&"click"===e.type).length)return void(this.config.debug&&console.warn("ErrorDetector: No click events in recovery session, skipping send",{totalEvents:t.length}));const s={sessionId:this.sessionManager.getSessionId(),events:t,capturedAt:(new Date).toISOString(),url:window.location.href};this.transport&&"function"==typeof this.transport.sendRecoverySession?(this.transport.sendRecoverySession(s,r).catch(e=>{console.error("ErrorDetector: Failed to send recovery session via transport",e)}),this.config.debug&&console.warn("ErrorDetector: Recovery session sent via transport",{eventCount:t.length,sessionId:s.sessionId,method:r?"sendBeacon":"fetch"})):(this.onErrorDetected&&this.onErrorDetected(e,t,{recovery:!0}),this.config.debug&&console.warn("ErrorDetector: Recovery session sent via callback",{eventCount:t.length}))}catch(e){console.error("ErrorDetector: Failed to send recovery session",e)}}getStats(){return{...this.stats,isInstalled:this.isInstalled,recentErrorsCount:this.recentErrors.size}}setEnabled(e){e&&!this.isInstalled?this.install():!e&&this.isInstalled&&this.uninstall()}isEnabled(){return this.isInstalled}}class u{constructor(e={}){this.config={sessionTimeoutMinutes:Math.min(e.sessionTimeoutMinutes||30,120),debug:e.debug||!1},this.STORAGE_KEY_SESSION_ID="_app_logger_session_id",this.STORAGE_KEY_SESSION_METADATA="_app_logger_session_metadata",this.sessionId=null,this.metadata={startedAt:null,lastActivityAt:null,pageCount:0,pages:[]},this.initialize(),this.config.debug&&console.warn("SessionManager initialized",{sessionId:this.sessionId,metadata:this.metadata})}initialize(){try{!this.loadSession()||this.isSessionExpired()?this.createNewSession():this.updateActivity(),this.trackPageView(window.location.href),this.setupPageTransitionTracking()}catch(e){console.error("SessionManager: Failed to initialize:",e),this.createNewSession()}}createNewSession(){try{this.sessionId=this.generateSessionId(),this.metadata={startedAt:Date.now(),lastActivityAt:Date.now(),pageCount:0,pages:[]},this.saveSession(),this.config.debug&&console.warn("SessionManager: Created new session",this.sessionId)}catch(e){console.error("SessionManager: Failed to create new session:",e)}}loadSession(){try{const e=localStorage.getItem(this.STORAGE_KEY_SESSION_ID),t=localStorage.getItem(this.STORAGE_KEY_SESSION_METADATA);if(!e||!t)return!1;const r=JSON.parse(t);return!(!r||!r.startedAt)&&(this.sessionId=e,this.metadata=r,this.config.debug&&console.warn("SessionManager: Loaded session",{sessionId:e,age:this.getSessionAge()}),!0)}catch(e){return console.error("SessionManager: Failed to load session:",e),!1}}saveSession(){try{localStorage.setItem(this.STORAGE_KEY_SESSION_ID,this.sessionId),localStorage.setItem(this.STORAGE_KEY_SESSION_METADATA,JSON.stringify(this.metadata))}catch(e){console.error("SessionManager: Failed to save session:",e)}}isSessionExpired(){try{if(!this.metadata.lastActivityAt)return!0;const e=Date.now(),t=this.metadata.lastActivityAt;return e-t>60*this.config.sessionTimeoutMinutes*1e3}catch{return!0}}updateActivity(){try{this.metadata.lastActivityAt=Date.now(),this.saveSession()}catch(e){console.error("SessionManager: Failed to update activity:",e)}}trackPageView(e){try{this.metadata.pageCount++,this.metadata.pages.push({url:e,timestamp:Date.now()}),this.metadata.pages.length>50&&(this.metadata.pages=this.metadata.pages.slice(-50)),this.updateActivity();const t={type:"pageTransition",url:e,timestamp:Date.now(),phase:"before_error",sessionId:this.sessionId,pageCount:this.metadata.pageCount};return this.config.debug&&console.warn("SessionManager: Page view tracked",{url:e,pageCount:this.metadata.pageCount}),t}catch(e){return console.error("SessionManager: Failed to track page view:",e),null}}setupPageTransitionTracking(){try{const e=history.pushState,t=history.replaceState;history.pushState=(...t)=>{e.apply(history,t),this.handleNavigationChange()},history.replaceState=(...e)=>{t.apply(history,e),this.handleNavigationChange()},window.addEventListener("popstate",()=>{this.handleNavigationChange()}),window.addEventListener("hashchange",()=>{this.handleNavigationChange()})}catch(e){console.error("SessionManager: Failed to setup page transition tracking:",e)}}handleNavigationChange(){try{const e=window.location.href;this.config.debug&&console.warn("SessionManager: Navigation detected",e),this.trackPageView(e)}catch(e){console.error("SessionManager: Failed to handle navigation change:",e)}}getSessionId(){return this.sessionId}getMetadata(){return{...this.metadata}}getSessionAge(){return this.metadata.startedAt?Date.now()-this.metadata.startedAt:0}generateSessionId(){try{return crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}catch{return`${Date.now()}-${Math.random().toString(36).substring(2,11)}`}}clearSession(){try{localStorage.removeItem(this.STORAGE_KEY_SESSION_ID),localStorage.removeItem(this.STORAGE_KEY_SESSION_METADATA),this.sessionId=null,this.metadata={startedAt:null,lastActivityAt:null,pageCount:0,pages:[]},this.config.debug&&console.warn("SessionManager: Session cleared")}catch(e){console.error("SessionManager: Failed to clear session:",e)}}extendSession(){try{this.updateActivity(),this.config.debug&&console.warn("SessionManager: Session extended")}catch(e){console.error("SessionManager: Failed to extend session:",e)}}getSessionInfo(){return{sessionId:this.sessionId,age:this.getSessionAge(),ageMinutes:Math.floor(this.getSessionAge()/1e3/60),isExpired:this.isSessionExpired(),pageCount:this.metadata.pageCount,recentPages:this.metadata.pages.slice(-5),timeoutMinutes:this.config.sessionTimeoutMinutes}}}class d{constructor(e={}){this.config={maxBufferSizeMB:Math.min(e.maxBufferSizeMB||5,20),debug:e.debug||!1},this.STORAGE_KEY_BUFFER="_app_logger_replay_buffer",this.STORAGE_KEY_METADATA="_app_logger_replay_metadata",this.stats={savesSuccessful:0,savesFailed:0,loadsSuccessful:0,loadsFailed:0,quotaExceededCount:0,cleanupCount:0},this.config.debug&&console.warn("StorageManager initialized with config:",this.config)}save(e){try{if(!e||"object"!=typeof e)return console.warn("StorageManager: Invalid buffer data"),!1;const t=this.estimateSize(e),r=1024*this.config.maxBufferSizeMB*1024;return t>r&&(this.config.debug&&console.warn("StorageManager: Buffer too large",{size:t,max:r,sizeMB:(t/1024/1024).toFixed(2)}),this.cleanup(),t>r&&(e=this.pruneBuffer(e,r))),localStorage.setItem(this.STORAGE_KEY_BUFFER,JSON.stringify(e)),this.saveMetadata({savedAt:Date.now(),size:t}),this.stats.savesSuccessful++,this.config.debug&&console.warn("StorageManager: Buffer saved",{size:t,events:e.buffer?.length||0}),!0}catch(t){if(this.stats.savesFailed++,"QuotaExceededError"===t.name){this.stats.quotaExceededCount++,this.config.debug&&console.warn("StorageManager: Quota exceeded, attempting cleanup"),this.cleanup();try{const t=this.pruneBuffer(e,1024*this.config.maxBufferSizeMB*1024/2);return localStorage.setItem(this.STORAGE_KEY_BUFFER,JSON.stringify(t)),this.stats.savesSuccessful++,!0}catch{return console.error("StorageManager: Failed to save even after cleanup"),!1}}return console.error("StorageManager: Failed to save buffer:",t),!1}}load(){try{const e=localStorage.getItem(this.STORAGE_KEY_BUFFER);if(!e)return null;const t=JSON.parse(e);return t&&"object"==typeof t?Array.isArray(t.buffer)?(this.stats.loadsSuccessful++,this.config.debug&&console.warn("StorageManager: Buffer loaded",{events:t.buffer.length,isRecording:t.isRecordingAfterError}),t):(console.warn("StorageManager: Invalid buffer structure"),null):null}catch(e){return this.stats.loadsFailed++,console.error("StorageManager: Failed to load buffer:",e),null}}clear(){try{localStorage.removeItem(this.STORAGE_KEY_BUFFER),localStorage.removeItem(this.STORAGE_KEY_METADATA),this.config.debug&&console.warn("StorageManager: Buffer cleared")}catch(e){console.error("StorageManager: Failed to clear buffer:",e)}}cleanup(){try{const e=this.loadMetadata();if(e&&e.savedAt){const t=Date.now()-e.savedAt;t>864e5&&(this.clear(),this.stats.cleanupCount++,this.config.debug&&console.warn("StorageManager: Cleaned up old buffer",{ageHours:(t/1e3/60/60).toFixed(1)}))}}catch(e){console.error("StorageManager: Cleanup failed:",e)}}saveMetadata(e){try{localStorage.setItem(this.STORAGE_KEY_METADATA,JSON.stringify(e))}catch(e){this.config.debug&&console.warn("StorageManager: Failed to save metadata:",e)}}loadMetadata(){try{const e=localStorage.getItem(this.STORAGE_KEY_METADATA);return e?JSON.parse(e):null}catch{return null}}pruneBuffer(e,t){try{if(!e.buffer||!Array.isArray(e.buffer))return e;const r={...e},s=[...e.buffer];for(;this.estimateSize(r)>t&&s.length>1;){const e=s.shift();if(e&&"error"===e.phase){s.unshift(e);break}r.buffer=s}return this.config.debug&&console.warn("StorageManager: Buffer pruned",{originalEvents:e.buffer.length,prunedEvents:s.length,originalSize:this.estimateSize(e),prunedSize:this.estimateSize(r)}),r}catch(t){return console.error("StorageManager: Failed to prune buffer:",t),e}}estimateSize(e){try{return JSON.stringify(e).length}catch{return 0}}getSpaceInfo(){try{const e="_app_logger_space_test",t="0".repeat(1024);let r=0,s=0;for(const e in localStorage)Object.prototype.hasOwnProperty.call(localStorage,e)&&(s+=localStorage[e].length+e.length);try{for(let s=0;s<1e4;s++)localStorage.setItem(e,t.repeat(s)),r=1024*s}catch{}finally{localStorage.removeItem(e)}return{usedBytes:s,usedMB:(s/1024/1024).toFixed(2),availableMB:(r/1024/1024).toFixed(2),totalMB:((s+r)/1024/1024).toFixed(2)}}catch{return{usedBytes:0,usedMB:"unknown",availableMB:"unknown",totalMB:"unknown"}}}getStats(){const e=this.getSpaceInfo();return{...this.stats,...e,maxBufferSizeMB:this.config.maxBufferSizeMB}}isAvailable(){try{const e="_app_logger_test";return localStorage.setItem(e,"test"),localStorage.removeItem(e),!0}catch{return!1}}}class g{constructor(r){if(!r||!r.dsn)throw new Error("ApplicationLogger: DSN is required. Expected format: https://host/project-id");if(!r.apiKey)throw new Error("ApplicationLogger: API Key is required for authentication");this.config={debug:!1,scrubFields:["password","token","api_key","secret"],sessionReplayEnabled:!0,bufferBeforeErrorSeconds:30,bufferBeforeErrorClicks:10,bufferAfterErrorSeconds:30,bufferAfterErrorClicks:10,snapshotThrottleMs:1e3,maxSnapshotSize:1048576,sessionTimeoutMinutes:30,maxBufferSizeMB:5,exposeApi:!0,circuitBreakerFailureThreshold:5,circuitBreakerTimeoutMs:6e4,storageQueueMaxSize:50,storageQueueMaxAgeMs:864e5,rateLimiterMaxTokens:10,rateLimiterRefillRate:.167,deduplicationWindowMs:5e3,...r},this.transport=new o(this.config),this.breadcrumbs=new t(50,(e,t)=>{this.config&&this.config.debug&&console.warn("ApplicationLogger: Auto-capturing error from console.error()",e),this.captureException(e,t)}),this.sessionManager=null,this.replayBuffer=null,this.storageManager=null,this.errorDetector=null,this.heatmap=null,this.config.sessionReplayEnabled&&this.initializeSessionReplay(),this.client=new e(this.config,this.transport,this.breadcrumbs,this.errorDetector,this.sessionManager),this.initialized=!1}initializeSessionReplay(){try{this.sessionManager=new u({sessionTimeoutMinutes:this.config.sessionTimeoutMinutes,debug:this.config.debug}),this.replayBuffer=new l({bufferBeforeErrorSeconds:this.config.bufferBeforeErrorSeconds,bufferBeforeErrorClicks:this.config.bufferBeforeErrorClicks,bufferAfterErrorSeconds:this.config.bufferAfterErrorSeconds,bufferAfterErrorClicks:this.config.bufferAfterErrorClicks,maxBufferSizeMB:this.config.maxBufferSizeMB,debug:this.config.debug}),this.storageManager=new d({maxBufferSizeMB:this.config.maxBufferSizeMB,debug:this.config.debug}),this.errorDetector=new h(this.replayBuffer,this.sessionManager,this.handleReplayCapture.bind(this),this.transport,{debug:this.config.debug,ignoreErrors:[]}),this.heatmap=new c(this.replayBuffer,this.sessionManager,this.config);const e=this.storageManager.load();e&&(this.replayBuffer.deserialize(e),this.config.debug&&console.warn("ApplicationLogger: Loaded replay buffer from localStorage",{events:e.buffer?.length||0})),this.config.debug&&console.warn("ApplicationLogger: Session replay initialized")}catch(e){console.error("ApplicationLogger: Failed to initialize session replay",e),this.config.sessionReplayEnabled=!1}}async handleReplayCapture(e,t,r){try{this.config.debug&&console.warn("ApplicationLogger: Replay captured for error",{errorMessage:e.message,eventCount:t.length,sessionId:this.sessionManager.getSessionId()});const r=this.replayBuffer.serialize();this.storageManager.save(r)}catch(e){console.error("ApplicationLogger: Failed to save replay buffer",e)}}init(){if(this.initialized)console.warn("ApplicationLogger already initialized");else if(this.breadcrumbs.install(),this.config.sessionReplayEnabled&&this.heatmap&&(this.heatmap.install(),this.errorDetector.install(),this.bufferSaveInterval=setInterval(()=>{this.saveBufferToStorage()},5e3),window.addEventListener("beforeunload",()=>{this.saveBufferToStorage()}),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&this.saveBufferToStorage()}),this.config.debug&&console.warn("ApplicationLogger: Session replay enabled (error-triggered, periodic saves every 5s)")),this.client.install(),this.initialized=!0,this.config.debug){const e=window._appLoggerBuffer?.startTime?Date.now()-window._appLoggerBuffer.startTime:"unknown";console.warn("ApplicationLogger initialized",{environment:this.config.environment,release:this.config.release,sessionReplayEnabled:this.config.sessionReplayEnabled,sessionId:this.sessionManager?.getSessionId(),sdkLoadTime:e+"ms",bufferedErrors:window._appLoggerBuffer?.errors?.length||0})}}saveBufferToStorage(){try{if(this.replayBuffer&&this.storageManager){const e=this.replayBuffer.serialize();this.storageManager.save(e),this.config.debug&&console.warn("ApplicationLogger: Buffer saved to localStorage")}}catch(e){console.error("ApplicationLogger: Failed to save buffer",e)}}captureException(e,t={}){this.client.captureException(e,t)}captureMessage(e,t="info",r={}){this.client.captureMessage(e,t,r)}addBreadcrumb(e){this.breadcrumbs.add(e)}setUser(e){this.client.setUser(e)}setTags(e){this.client.setTags(e)}setExtra(e){this.client.setExtra(e)}get sessionReplay(){return this.config.exposeApi?{enable:()=>{this.config.sessionReplayEnabled||(this.config.sessionReplayEnabled=!0,this.heatmap||(this.initializeSessionReplay(),this.initialized&&this.heatmap&&(this.heatmap.install(),this.errorDetector.install())),this.config.debug&&console.warn("ApplicationLogger: Session replay enabled"))},disable:()=>{this.config.sessionReplayEnabled&&(this.config.sessionReplayEnabled=!1,this.bufferSaveInterval&&(clearInterval(this.bufferSaveInterval),this.bufferSaveInterval=null),this.heatmap&&this.heatmap.cleanup(),this.errorDetector&&this.errorDetector.uninstall(),this.saveBufferToStorage(),this.config.debug&&console.warn("ApplicationLogger: Session replay disabled"))},isEnabled:()=>this.config.sessionReplayEnabled,getStats:()=>this.config.sessionReplayEnabled?{enabled:!0,sessionId:this.sessionManager?.getSessionId(),sessionAge:this.sessionManager?.getSessionAge(),bufferStats:this.replayBuffer?.getStats(),storageStats:this.storageManager?.getStats(),domCaptureStats:this.heatmap?.getDOMCaptureStats(),debounceStats:this.heatmap?.getDebounceStats(),errorDetectorStats:this.errorDetector?.getStats()}:{enabled:!1}}:null}}"undefined"!=typeof window&&(window.ApplicationLogger=g);export{g as default};
//# sourceMappingURL=logger.js.map
