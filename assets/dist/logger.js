class t{constructor(t,e,s){this.config=t,this.transport=e,this.breadcrumbs=s,this.userContext=null,this.tags={},this.extra={},this.pendingBeaconErrors=[]}install(){try{window.addEventListener("error",t=>{try{this.captureException(t.error||new Error(t.message),{extra:{filename:t.filename,lineno:t.lineno,colno:t.colno}})}catch(t){console.error("ApplicationLogger: Failed to capture error",t)}}),window.addEventListener("unhandledrejection",t=>{try{this.captureException(t.reason,{extra:{type:"unhandledrejection"}})}catch(t){console.error("ApplicationLogger: Failed to capture rejection",t)}}),window.addEventListener("beforeunload",()=>{this.flushBeaconErrors()}),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&this.flushBeaconErrors()}),this.breadcrumbs.install()}catch(t){console.error("ApplicationLogger: Failed to install",t)}}captureException(t,e={}){const s=this.buildPayload(t,"error",e);this.transport.send(s)}captureMessage(t,e="info",s={}){const i=this.buildPayload(new Error(t),e,s);this.transport.send(i)}buildPayload(t,e,s={}){try{const i=this.parseStackTrace(t),r=i.length>0?i[0]:null,n={type:t.name||"Error",message:t.message||"Unknown error",file:r?.file||s.extra?.filename||"unknown",line:r?.line||s.extra?.lineno||0,stack_trace:i,level:e||"error",source:"frontend",environment:this.config.environment||"production",release:this.config.release||null,url:window.location.href,http_method:this.detectHttpMethod(),http_status_code:this.extractHttpStatusCode(t,s),session_hash:this.getSessionHash(),timestamp:(new Date).toISOString(),runtime:`JavaScript ${this.getBrowserInfo()}`,user_agent:navigator.userAgent,breadcrumbs:this.breadcrumbs.get(),context:{...this.extra,...s.extra},tags:{...this.tags,...s.tags}};return this.removeNullValues(n)}catch(t){return console.error("ApplicationLogger: Failed to build payload",t),{type:"Error",message:"Failed to build error payload",file:"unknown",line:0,stack_trace:[],level:"error"}}}parseStackTrace(t){if(!t.stack)return[{file:"unknown",line:0,function:"unknown"}];try{const e=t.stack.split("\n"),s=[];for(const t of e){const e=this.parseStackLine(t.trim());e&&s.push(e)}return s.length>0?s:[{file:"unknown",line:0,function:"unknown"}]}catch{return[{file:"unknown",line:0,function:"unknown"}]}}parseStackLine(t){if(!t)return null;let e=t.match(/at\s+(.+?)\s+\((.+?):(\d+):(\d+)\)/);return e?{function:e[1].trim(),file:e[2],line:parseInt(e[3],10),column:parseInt(e[4],10)}:(e=t.match(/at\s+(.+?):(\d+):(\d+)/),e?{function:"anonymous",file:e[1],line:parseInt(e[2],10),column:parseInt(e[3],10)}:(e=t.match(/(.+?)@(.+?):(\d+):(\d+)/),e?{function:e[1]||"anonymous",file:e[2],line:parseInt(e[3],10),column:parseInt(e[4],10)}:(e=t.match(/(?:(.+)@)?(.+?):(\d+)$/),e?{function:e[1]||"anonymous",file:e[2],line:parseInt(e[3],10),column:null}:(e=t.match(/at\s+(.+?)\s+\[(.+?):(\d+):(\d+)\]/),e?{function:e[1].trim(),file:e[2],line:parseInt(e[3],10),column:parseInt(e[4],10)}:null))))}detectHttpMethod(){try{const t=performance.getEntriesByType("navigation")[0];if(t&&t.type)return"GET"}catch{}return"GET"}extractHttpStatusCode(t,e={}){try{if(t.status&&"number"==typeof t.status)return t.status;if(e.httpStatusCode&&"number"==typeof e.httpStatusCode)return e.httpStatusCode;if(e.extra?.http_status_code&&"number"==typeof e.extra.http_status_code)return e.extra.http_status_code;if(e.extra?.httpStatusCode&&"number"==typeof e.extra.httpStatusCode)return e.extra.httpStatusCode;if(t.message){const e=t.message.match(/HTTP\s+(\d{3})/i);if(e){const t=parseInt(e[1],10);if(t>=100&&t<600)return t}}return null}catch{return null}}getBrowserInfo(){const t=navigator.userAgent;return t.includes("Chrome")&&!t.includes("Edge")?"Chrome":t.includes("Firefox")?"Firefox":t.includes("Safari")&&!t.includes("Chrome")?"Safari":t.includes("Edge")||t.includes("Edg/")?"Edge":t.includes("MSIE")||t.includes("Trident/")?"IE":"Unknown"}getSessionHash(){try{if(this.config.sessionHash)return this.config.sessionHash;if("undefined"!=typeof sessionStorage){let t=sessionStorage.getItem("_app_logger_session_id");return t||(t=this.generateSessionId(),sessionStorage.setItem("_app_logger_session_id",t)),this.sha256(t)}return null}catch{return null}}generateSessionId(){return crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})}sha256(t){let e=5381;for(let s=0;s<t.length;s++)e=(e<<5)+e+t.charCodeAt(s);return Math.abs(e).toString(16).padStart(64,"0")}removeNullValues(t){const e={};for(const[s,i]of Object.entries(t))null!=i&&(e[s]=i);return e}setUser(t){this.userContext=t}setTags(t){this.tags={...this.tags,...t}}setExtra(t){this.extra={...this.extra,...t}}flushBeaconErrors(){try{if(!navigator.sendBeacon)return;const t=this.transport.getStats();if(0===t.storedErrors&&0===t.queueSize)return;this.transport.flushWithBeacon()}catch{}}}class e{constructor(t=50){this.breadcrumbs=[],this.maxBreadcrumbs=t}install(){document.addEventListener("click",t=>{const e=t.target,s=e.tagName.toLowerCase();let i=`Clicked ${s}`;const r=(n=e).className?"object"==typeof n.className&&void 0!==n.className.baseVal?n.className.baseVal:n.className:"";var n;if(e.id)i+=`#${e.id}`;else if(r){const t=r.split(" ")[0];t&&(i+=`.${t}`)}this.add({type:"ui",category:"click",message:i,data:{tag:s,id:e.id,class:r}})},!0);const t=history.pushState,e=history.replaceState;history.pushState=(...e)=>(this.add({type:"navigation",category:"navigation",message:`Navigated to ${e[2]}`,data:{to:e[2]}}),t.apply(history,e)),history.replaceState=(...t)=>(this.add({type:"navigation",category:"navigation",message:`Replaced state ${t[2]}`,data:{to:t[2]}}),e.apply(history,t)),this.wrapConsole(),this.wrapFetch()}add(t){this.breadcrumbs.push({timestamp:(new Date).toISOString(),level:t.level||"info",...t}),this.breadcrumbs.length>this.maxBreadcrumbs&&this.breadcrumbs.shift()}get(){return this.breadcrumbs}clear(){this.breadcrumbs=[]}wrapConsole(){["log","info","warn","error","debug"].forEach(t=>{const e=console[t];console[t]=(...s)=>(this.add({type:"console",category:"console",message:s.join(" "),level:"log"===t?"info":t,data:{arguments:s}}),e.apply(console,s))})}wrapFetch(){const t=window.fetch;window.fetch=async(...e)=>{const s="string"==typeof e[0]?e[0]:e[0].url,i=e[1]?.method||"GET",r=Date.now();try{const n=await t.apply(window,e),a=Date.now()-r;return this.add({type:"http",category:"fetch",message:`${i} ${s}`,data:{url:s,method:i,status_code:n.status,duration:a},level:n.ok?"info":"warning"}),n}catch(t){const e=Date.now()-r;throw this.add({type:"http",category:"fetch",message:`${i} ${s} failed`,data:{url:s,method:i,error:t.message,duration:e},level:"error"}),t}}}}class s{static STATE_CLOSED="closed";static STATE_OPEN="open";static STATE_HALF_OPEN="half_open";constructor(t={}){this.failureThreshold=t.failureThreshold||5,this.timeout=t.timeout||6e4,this.storageKey="app_logger_circuit_breaker",this.loadState()}isOpen(){return this.state===s.STATE_OPEN&&this.shouldAttemptReset()&&this.halfOpen(),this.state===s.STATE_OPEN}isHalfOpen(){return this.state===s.STATE_HALF_OPEN}recordSuccess(){this.state===s.STATE_HALF_OPEN?this.close():this.state===s.STATE_CLOSED&&(this.failureCount=0,this.saveState())}recordFailure(){this.state===s.STATE_HALF_OPEN?this.open():this.state===s.STATE_CLOSED&&(this.failureCount++,this.failureCount>=this.failureThreshold?this.open():this.saveState())}getState(){return{state:this.state,failureCount:this.failureCount,openedAt:this.openedAt}}reset(){this.close()}close(){this.state=s.STATE_CLOSED,this.failureCount=0,this.openedAt=null,this.saveState()}open(){this.state=s.STATE_OPEN,this.openedAt=Date.now(),this.saveState()}halfOpen(){this.state=s.STATE_HALF_OPEN,this.saveState()}shouldAttemptReset(){return!!this.openedAt&&Date.now()-this.openedAt>=this.timeout}loadState(){try{const t=sessionStorage.getItem(this.storageKey);if(t){const e=JSON.parse(t);this.state=e.state||s.STATE_CLOSED,this.failureCount=e.failureCount||0,this.openedAt=e.openedAt||null}else this.state=s.STATE_CLOSED,this.failureCount=0,this.openedAt=null}catch{this.state=s.STATE_CLOSED,this.failureCount=0,this.openedAt=null}}saveState(){try{const t={state:this.state,failureCount:this.failureCount,openedAt:this.openedAt};sessionStorage.setItem(this.storageKey,JSON.stringify(t))}catch{}}}class i{constructor(t={}){this.storageKey="app_logger_queue",this.maxSize=t.maxSize||50,this.maxAge=t.maxAge||864e5}enqueue(t){try{const e=this.getQueue(),s={payload:t,timestamp:Date.now()};e.push(s),e.length>this.maxSize&&e.shift(),this.saveQueue(e)}catch(t){console.warn("ApplicationLogger: Failed to queue error",t)}}dequeue(){try{const t=this.getQueue();if(0===t.length)return null;const e=t.shift();return this.saveQueue(t),e.payload}catch{return null}}getAll(){return this.getQueue().map(t=>t.payload)}size(){return this.getQueue().length}clear(){try{localStorage.removeItem(this.storageKey)}catch{}}getQueue(){try{const t=localStorage.getItem(this.storageKey);if(!t)return[];const e=JSON.parse(t);if(!Array.isArray(e))return[];const s=Date.now(),i=e.filter(t=>t.timestamp&&s-t.timestamp<this.maxAge);return i.length!==e.length&&this.saveQueue(i),i}catch{return[]}}saveQueue(t){try{localStorage.setItem(this.storageKey,JSON.stringify(t))}catch(e){if("QuotaExceededError"===e.name){const e=Math.floor(t.length/2),s=t.slice(-e);try{localStorage.setItem(this.storageKey,JSON.stringify(s))}catch{this.clear()}}}}}class r{constructor(t={}){this.maxTokens=t.maxTokens||10,this.refillRate=t.refillRate||1,this.tokens=this.maxTokens,this.lastRefill=Date.now()}isAllowed(){return this.refillTokens(),this.tokens>0}consume(){return!!this.isAllowed()&&(this.tokens--,!0)}refillTokens(){const t=Date.now(),e=(t-this.lastRefill)/1e3,s=Math.floor(e*this.refillRate);s>0&&(this.tokens=Math.min(this.maxTokens,this.tokens+s),this.lastRefill=t)}getTokens(){return this.refillTokens(),this.tokens}reset(){this.tokens=this.maxTokens,this.lastRefill=Date.now()}}class n{constructor(t){this.config=t,this.apiKey=t.apiKey,this.dsn=this.parseDsn(t.dsn),this.queue=[],this.sending=!1,this.circuitBreaker=new s({failureThreshold:5,timeout:6e4}),this.storageQueue=new i({maxSize:50,maxAge:864e5}),this.rateLimiter=new r({maxTokens:10,refillRate:.167}),this.recentErrors=new Map,this.deduplicationWindow=5e3,this.flushStoredErrors()}parseDsn(t){if(!t)throw new Error("DSN is required");try{const e=new URL(t),s=e.pathname.replace(/^\//,"");if(!s)throw new Error("DSN must include a project ID in the path");return{protocol:e.protocol.replace(":",""),host:e.host,projectId:s,endpoint:`${e.protocol}//${e.host}/api/errors/ingest`}}catch(t){throw new Error(`Invalid DSN format: ${t.message}. Expected: https://host/project-id`)}}async send(t){try{const e=this.scrubSensitiveData(t);if(this.isDuplicate(e))return void(this.config.debug&&console.warn("ApplicationLogger: Duplicate error ignored"));if(!this.rateLimiter.consume())return this.config.debug&&console.warn("ApplicationLogger: Rate limit exceeded, error queued"),void this.storageQueue.enqueue(e);this.queue.push(e),this.sending||await this.processQueue()}catch(t){console.error("ApplicationLogger: Send failed",t)}}async processQueue(){if(0!==this.queue.length&&!this.sending){for(this.sending=!0;this.queue.length>0;){const t=this.queue.shift();try{await this.sendToApi(t),this.config.debug&&console.warn("ApplicationLogger: Error sent successfully")}catch{}}this.sending=!1}}async sendToApi(t,e=0){if(this.circuitBreaker.isOpen())return this.config.debug&&console.warn("ApplicationLogger: Circuit breaker is open, error queued to storage"),void this.storageQueue.enqueue(t);const s=new AbortController,i=setTimeout(()=>s.abort(),3e3);try{const e=await fetch(this.dsn.endpoint,{method:"POST",headers:{"Content-Type":"application/json","X-Api-Key":this.apiKey,"User-Agent":"ApplicationLogger-JS-SDK/1.0"},body:JSON.stringify(t),signal:s.signal});if(clearTimeout(i),!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);return this.circuitBreaker.recordSuccess(),this.flushStoredErrors(),e.json()}catch(s){if(clearTimeout(i),"AbortError"===s.name)return this.circuitBreaker.recordFailure(),this.config.debug&&console.error("ApplicationLogger: Request timeout"),void this.storageQueue.enqueue(t);if(e<2){const s=1e3*Math.pow(2,e);return await this.delay(s),this.sendToApi(t,e+1)}this.circuitBreaker.recordFailure(),this.config.debug&&console.error("ApplicationLogger: Max retries reached",s),this.storageQueue.enqueue(t)}}isDuplicate(t){try{const e=JSON.stringify({type:t.exception?.type,message:t.exception?.value,stack:t.exception?.stacktrace?.frames?.slice(0,3)}),s=this.simpleHash(e);if(this.recentErrors.has(s))return!0;this.recentErrors.set(s,Date.now());const i=Date.now();for(const[t,e]of this.recentErrors)i-e>this.deduplicationWindow&&this.recentErrors.delete(t);return!1}catch{return!1}}simpleHash(t){let e=0;for(let s=0;s<t.length;s++){e=(e<<5)-e+t.charCodeAt(s),e&=e}return e.toString()}async flushStoredErrors(){try{const t=this.storageQueue.size();if(0===t)return;this.config.debug&&console.warn(`ApplicationLogger: Flushing ${t} stored errors`);const e=Math.min(t,5);for(let t=0;t<e;t++){const t=this.storageQueue.dequeue();t&&this.queue.push(t)}!this.sending&&this.queue.length>0&&await this.processQueue()}catch(t){this.config.debug&&console.error("ApplicationLogger: Flush failed",t)}}delay(t){return new Promise(e=>setTimeout(e,t))}scrubSensitiveData(t){const e=[...this.config.scrubFields||[],"password","passwd","pwd","secret","api_key","apikey","token","auth","authorization","private_key","access_token","refresh_token"],s=JSON.parse(JSON.stringify(t)),i=t=>{if(!t||"object"!=typeof t)return t;for(const s in t)if(Object.prototype.hasOwnProperty.call(t,s)){e.some(t=>s.toLowerCase().includes(t.toLowerCase()))?t[s]="[REDACTED]":"object"==typeof t[s]&&i(t[s])}return t};return i(s)}async sendSessionEvent(t,e){if(t&&e)try{const s=`${this.dsn.protocol}://${this.dsn.host}/api/v1/sessions/${t}/events`,i=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","X-Api-Key":this.apiKey,"User-Agent":"ApplicationLogger-JS-SDK/1.0"},body:JSON.stringify(e)});if(!i.ok)throw new Error(`HTTP ${i.status}`);return i.json()}catch(t){this.config.debug&&console.error("ApplicationLogger: Failed to send session event",t)}}async sendHeatmap(t,e){if(t&&e&&0!==e.length)try{const s=`${this.dsn.protocol}://${this.dsn.host}/api/v1/sessions/${t}/heatmap`,i=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","X-Api-Key":this.apiKey,"User-Agent":"ApplicationLogger-JS-SDK/1.0"},body:JSON.stringify({clicks:e})});if(!i.ok)throw new Error(`HTTP ${i.status}`);return this.config.debug&&console.warn(`ApplicationLogger: Sent ${e.length} heatmap clicks`),i.json()}catch(t){this.config.debug&&console.error("ApplicationLogger: Failed to send heatmap data",t)}}getStats(){return{queueSize:this.queue.length,storedErrors:this.storageQueue.size(),circuitBreaker:this.circuitBreaker.getState(),rateLimitTokens:this.rateLimiter.getTokens()}}flushWithBeacon(){try{const t=this.storageQueue.getAll(),e=[...this.queue,...t];if(0===e.length)return;const s=e.slice(-10),i={dsn:this.config.dsn,errors:s},r=new Blob([JSON.stringify(i)],{type:"application/json"});navigator.sendBeacon(this.dsn.endpoint,r)&&(this.storageQueue.clear(),this.queue=[],this.config.debug&&console.warn(`ApplicationLogger: Flushed ${s.length} errors via Beacon API`))}catch(t){this.config.debug&&console.error("ApplicationLogger: Beacon flush failed",t)}}}class a{constructor(t,e){this.transport=t,this.config=e,this.clickQueue=[],this.batchSize=e.heatmapBatchSize||10,this.batchTimeout=e.heatmapBatchTimeout||5e3,this.batchTimer=null,this.isInstalled=!1,this.sessionId=null}install(t){if(!this.isInstalled){this.sessionId=t;try{document.addEventListener("click",t=>{this.captureClick(t)},!0),window.addEventListener("beforeunload",()=>{this.flush()}),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&this.flush()}),this.isInstalled=!0}catch(t){console.error("ApplicationLogger: Failed to install heatmap tracker",t)}}}captureClick(t){try{const e={type:"click",url:window.location.href,x:t.pageX,y:t.pageY,viewport_width:window.innerWidth,viewport_height:window.innerHeight,element_selector:this.generateSelector(t.target),timestamp:(new Date).toISOString(),session_id:this.sessionId};this.clickQueue.push(e),this.clickQueue.length>=this.batchSize?this.flush():this.scheduleBatchSend()}catch(t){console.error("ApplicationLogger: Failed to capture click",t)}}generateSelector(t){if(!t||t===document)return"";try{const e=[];let s=t,i=0;const r=5;for(;s&&s!==document&&i<r;){let t=s.tagName.toLowerCase();if(s.id&&!this.containsSensitiveData(s.id)){t+=`#${CSS.escape(s.id)}`,e.unshift(t);break}const r=this.getCleanClasses(s);r.length>0&&(t+=`.${r.join(".")}`);const n=s.parentElement?Array.from(s.parentElement.children).filter(t=>t.tagName===s.tagName):[];if(n.length>1){t+=`:nth-child(${n.indexOf(s)+1})`}e.unshift(t),s=s.parentElement,i++}return e.join(" > ")}catch{return t.tagName?t.tagName.toLowerCase():"unknown"}}getCleanClasses(t){if(!t.classList||0===t.classList.length)return[];return Array.from(t.classList).filter(t=>!t.match(/^(active|hover|focus|disabled|hidden|show)$/)&&(!t.match(/^(ng-|v-|data-|_)/)&&!this.containsSensitiveData(t))).map(t=>CSS.escape(t)).slice(0,3)}containsSensitiveData(t){return[/user[-_]?id/i,/email/i,/token/i,/session/i,/auth/i,/key/i,/\d{10,}/].some(e=>e.test(t))}scheduleBatchSend(){this.batchTimer&&clearTimeout(this.batchTimer),this.batchTimer=setTimeout(()=>{this.flush()},this.batchTimeout)}flush(){if(0!==this.clickQueue.length)try{this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null);const t=[...this.clickQueue];this.clickQueue=[],this.sendHeatmapData(t)}catch(t){console.error("ApplicationLogger: Failed to flush heatmap data",t)}}async sendHeatmapData(t){if(this.sessionId&&0!==t.length)try{if(this.transport.sendHeatmap)await this.transport.sendHeatmap(this.sessionId,t);else{const e=t.map(t=>({type:"HEATMAP_CLICK",url:t.url,timestamp:t.timestamp,data:t}));for(const t of e)await this.transport.sendSessionEvent(this.sessionId,t)}}catch(t){console.error("ApplicationLogger: Failed to send heatmap data",t)}}getQueueSize(){return this.clickQueue.length}}class o{constructor(s){if(!s||!s.dsn)throw new Error("ApplicationLogger: DSN is required. Expected format: https://host/project-id");if(!s.apiKey)throw new Error("ApplicationLogger: API Key is required for authentication");this.config={debug:!1,scrubFields:["password","token","api_key","secret"],enableHeatmap:!0,heatmapBatchSize:10,heatmapBatchTimeout:5e3,...s},this.transport=new n(this.config),this.breadcrumbs=new e,this.client=new t(this.config,this.transport,this.breadcrumbs),this.heatmap=new a(this.transport,this.config),this.initialized=!1}init(){this.initialized?console.warn("ApplicationLogger already initialized"):(this.client.install(),this.config.enableHeatmap&&this.config.sessionId&&(this.heatmap.install(this.config.sessionId),this.config.debug&&console.log("ApplicationLogger: Heatmap tracking enabled")),this.initialized=!0,this.config.debug&&console.log("ApplicationLogger initialized",this.config))}captureException(t,e={}){this.client.captureException(t,e)}captureMessage(t,e="info",s={}){this.client.captureMessage(t,e,s)}addBreadcrumb(t){this.breadcrumbs.add(t)}setUser(t){this.client.setUser(t)}setTags(t){this.client.setTags(t)}setExtra(t){this.client.setExtra(t)}}"undefined"!=typeof window&&(window.ApplicationLogger=o);export{o as default};
//# sourceMappingURL=logger.js.map
